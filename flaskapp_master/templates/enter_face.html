<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title>录入信息</title>
    <script src="/static/js/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background: radial-gradient(200% 100% at bottom center, #f7f7b6, #e96f92, #75517d, #1b2947);
            background: radial-gradient(220% 105% at top center, #1b2947 10%, #75517d 40%, #e96f92 65%, #f7f7b6);
            background-attachment: fixed;
            overflow-x: hidden;
        }

        @keyframes rotate {
            0% {
                transform: perspective(400px) rotateZ(20deg) rotateX(-40deg) rotateY(0);
            }
            100% {
                transform: perspective(400px) rotateZ(20deg) rotateX(-40deg) rotateY(-360deg);
            }
        }

        .stars {
            transform: perspective(500px);
            transform-style: preserve-3d;
            position: absolute;
            bottom: 0;
            perspective-origin: 50% 100%;
            left: 50%;
            animation: rotate 90s infinite linear;
        }

        .star {
            width: 2px;
            height: 2px;
            background: #F7F7B6;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0 -300px;
            transform: translate3d(0, 0, -300px);
            backface-visibility: hidden;
        }

        .table {
            width: 60%;
            height: 100%;
            margin: 20px auto;
        }

        .table form {
            width: 100%;
        }

        .table .name {
            width: 128%;
            color: white;
            display: block;
            height: 30px;
            border-radius: 20px;
            border: none;
            background: rgba(0, 0, 0, 0.2);
            text-indent: 0.8em;
        }

        .table .btn {
            width: 100px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: none;
            color: white;
            margin: 0 auto;
            display: block;
        }

        .nav-link.active {
            color: white;
            font-weight: bold;
        }

        .container > div {
            margin: 15px 20px;
        }
    </style>

</head>
<body style="" onload="WebSocketTest()">
<div id="bg"></div>
<script>
    $(document).ready(function () {
        $("#bg").load("/static/stars_ele.html");
    })
</script>

<div class="table">
    <ul class="nav" style="margin-left: 15%;">
        <li class="nav-item">
            <a class="nav-link active">录入信息</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/recognize_face">人脸识别</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="http://blog.xiaozie.top" target="_blank">关于</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">联系作者</a>
        </li>
    </ul>

    <form method="post">

        <div class="container">
            <div class="row">
                <div style="padding-left: 40px;color: white;font-weight: bold">
                    姓名：
                </div>
                <div class="col-6">
                    <input type="text" id="name" name="name" class="name" placeholder="请输入"/>
                </div>
            </div>
            <div class="row">
                <div style="padding-left: 40px;color: white;font-weight: bold">
                    摄像头：
                </div>
                <div class="col-5">
                    <video id="video" style="width: 150%;border-radius: 5px;" autoplay="autoplay"></video>
                </div>
                <div class="col" style="margin-left: -25px;">
                    <span id="capture" class="btn btn-primary" style="background: #007bff54;width: 17%;">拍照</span>
                </div>
            </div>
            <div class="row" style="min-height: 185px;">
                <div style="padding-left: 40px;color: white;font-weight: bold">
                    预览图：
                </div>
                <div class="col-8">
                    <canvas id="canvas" style="width: 45%;border-radius: 5px;"></canvas>
                    <img src="" id="img" style="width: 45%;border-radius: 5px;vertical-align: unset;" hidden="hidden"/>
                    <div id="imgload" class="spinner-border text-light" role="status"
                         style="display: flex;margin-left: 65%;margin-top: -20%;" hidden>
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="row">
                <span id="submit" class="btn" style="margin: 0 40%">采集录入</span>
            </div>
        </div>


    </form>
</div>

<script>
    var socket;

    function WebSocketTest() {
        if ("WebSocket" in window) {
            // 打开一个 web socket
            var ws = new WebSocket("ws://127.0.0.1:5678");
            socket = ws;
            // 连接建立后的回调函数
            ws.onopen = function () {
                ws.send("begin");
            };

            // 接收到服务器消息后的回调函数
            ws.onmessage = function (evt) {
                // alert(evt)
                received_msg = evt.data;
                received_msg = JSON.parse(received_msg)
                // alert(received_msg)
                // console.log(received_msg)
                if (received_msg.type == 0) {
                    if (received_msg.img.startsWith("data:")) {
                        $("#imgload").attr("hidden", "hidden")
                        $("#img").removeAttr("hidden")
                        document.getElementById('img').src = received_msg.img;
                    } else {
                        $("#img").attr("hidden", "hidden")
                        // $("#imgload").removeAttr("hidden")
                    }
                } else if (received_msg.type == 2) {
                    alert(received_msg.data)
                    location.href = "/recognize_face"
                    console.log(received_msg)
                }

            };

            // 连接关闭后的回调函数
            ws.onclose = function () {
                // 关闭 websocket
                alert("WebSocket连接失败...");
            };
        } else {
            // 浏览器不支持 WebSocket
            alert("您的浏览器不支持 WebSocket!");
        }
    }

    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let context = canvas.getContext("2d");

    // 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
    if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
    }

    // 一些浏览器部分支持 mediaDevices。我们不能直接给对象设置 getUserMedia
    // 因为这样可能会覆盖已有的属性。这里我们只会在没有getUserMedia属性的时候添加它。
    if (navigator.mediaDevices.getUserMedia === undefined) {
        navigator.mediaDevices.getUserMedia = function (constraints) {

            // 首先，如果有getUserMedia的话，就获得它
            var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

            // 一些浏览器根本没实现它 - 那么就返回一个error到promise的reject来保持一个统一的接口
            if (!getUserMedia) {
                return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
            }

            // 否则，为老的navigator.getUserMedia方法包裹一个Promise
            return new Promise(function (resolve, reject) {
                getUserMedia.call(navigator, constraints, resolve, reject);
            });
        }
    }

    //默认使用前摄像头，强制使用后置摄像头如下设置
    // let constraints = {video: { facingMode: { exact: "environment" } }};
    let constraints = {video: true};
    navigator.mediaDevices.getUserMedia(constraints)
        .then(function (stream) {
            // 旧的浏览器可能没有srcObject
            if ("srcObject" in video) {
                video.srcObject = stream;
            } else {
                // 防止在新的浏览器里使用它，应为它已经不再支持了
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function (e) {
                video.play();
            };
        })
        .catch(function (err) {
            console.log(err.name + ": " + err.message);
        });

    //注册拍照按钮的单击事件
    document.getElementById("capture").addEventListener("click", function () {
        //绘制画面
        // context.drawImage(video, 0, 0, 640, 480);
        scamera()
    });

    //注册采集录入点击事件
    document.getElementById("submit").addEventListener("click", function () {
        if ($("#name").val() == "") {
            alert("请先输入名称！")
            return;
        } else if ($("#img").attr("src") == "") {
            alert("请先点击拍照!")
            return;
        }
        var imgData = canvas.toDataURL();
        console.log(imgData)
        imgData = imgData.substring(22);
        s_data = {"type": 2, "data": imgData, "name": $("#name").val()}
        sendMeg(JSON.stringify(s_data));


    });

    function scamera() {
        //截图
        var ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, 640, 480);

        var imgData = canvas.toDataURL();
        // console.log(imgData)
        imgData = imgData.substring(22);
        $("#imgload").removeAttr("hidden")
        s_data = {"type": 0, "data": imgData}
        sendMeg(JSON.stringify(s_data));

    }

    function sendMeg(base64_str) {
        socket.send(base64_str);
    }

</script>

<script>
    <!--  背景特效  -->
    $(document).ready(function () {
        var stars = 8000;  /*星星的密集程度，数字越大越多*/
        var $stars = $(".stars");
        var r = 600;   /*星星的看起来的距离,值越大越远,可自行调制到自己满意的样子*/
        for (var i = 0; i < stars; i++) {
            var $star = $("<div/>").addClass("star");
            $stars.append($star);
        }
        $(".star").each(function () {
            var cur = $(this);
            var s = 0.2 + (Math.random() * 1);
            var curR = r + (Math.random() * 300);
            cur.css({
                transformOrigin: "0 0 " + curR + "px",
                transform: " translate3d(0,0,-" + curR + "px) rotateY(" + (Math.random() * 360) + "deg) rotateX(" + (Math.random() * -50) + "deg) scale(" + s + "," + s + ")"

            })
        })
    })
</script>

</body>
</html>